[![test-workflow][test-workflow-badge]][ci-test]

# memstat

terminal-based heap allocation plotter for Node

![Mocha test with an ASCII plot timeline of the memory usage][demo]

## Install

```bash
npm i git+ssh://git@github.com:nicholaswmin/memstat.git
```

## Usage

Run a potentially leaky function 100 times,
then plot the allocation timeline:

```js
import Memstat from 'memstat'

const memstat = Memstat()

for (let i = 0; i < 100; i++)
  await memstat.sample(() => leakyFunction())

const usage = await memstat.end()

console.log(usage.plot)
```

### Time based collection

`memstat.record()`

```js
app.get('/users', (req, res) => {
  const memstat = Memstat()
  await  memstat.record()

  for (let i = 0; i < 200; i++)
    leakyFunction('leak')

  // or anything sync or async.. .

  res.json({ foo: 'bar' })

  console.log(await memstat.getUsageReport())
})
```

> Actually, it's immediately following a garbage collection cycle, so not
> actually "time" based.

### Additional stats

Apart from the ASCII plot, `memstat.end()` returns:

```js
console.log(usage)
/*
  initial: 10485760, // heap size bytes on instantiation
  current: 15728640, // current heap size bytes
  max: 15728640, // max heap size bytes reached
  percentageIncrease: 49, // increase between initial - now, in %
  snapshots: [10485760, 12582912, 14680064, ....] // snapshots
*/
```

these values are generated by [v8.getHeapStatistics().heapUsed][v8-heap-doc]

### As a unit-testing utility

This tool was made for integration into a testing suite.

In [Mocha][mocha], you can pass the test context to `memstat.end(this)` and
the plot will draw on failed tests:

```js
describe ('when the function is run 100 times', function() {

  it ('does not leak memory', async function() {
    for (let i = 0; i < 200; i++)
      await memstat.sample(() => leakyFunction(2, 3))

    const usage = memstat.end(this) // pass this

    expect(usage.percentageIncrease).to.be.below(10)
    expect(usage.current).to.be.below(1024 * 1024 * 100)
  })
})
```

### Tail mode

To observe realtime heap statistics:

```js
import Memstat from 'memstat'
```

and start with flag `--memstat`, i.e:

```bash
node app.js --memstat
```

which does this:

![Animation showing live memory usage plotting in terminal][tail-demo]

## Test

```bash
npm test
```

### Notes

- [Don't use arrow functions][no-mocha-arrow] in Mochas `describe`/`it`,
  otherwise `this` will be rescoped.
- Make sure you `await memstat.sample(() => functionUnderTest())`
- Garbage collectors are smart enough to know when to run and when not.
  Unless the GC has good reason to believe it's about to be OOM-ed,
  it probably won't kick in.

A simple way to trick it into waking up is by doing something like this:

```js
// leak ~10 MB per second for 5 seconds without blocking the Event Loop
const rand = Math.random().toString().slice(2, 10)
const timer = setInterval(() => {
  global[rand] = global[rand] || []
  global[rand].push(JSON.stringify({
    val: rand.repeat(100000 * 10)
  }))
}, 1000)

setTimeout(() => clearInterval(timer), 5000)
```

[More examples here][examples].

### License

> 2024 Nik Kyriakides, [@nicholaswmin][wmin]

> The MIT License

> Permission is hereby granted, free of charge, to any person obtaining a copy
> of this software and associated documentation files (the "Software"), to deal
> in the Software without restriction, including without limitation the rights
> to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
> copies of the Software, and to permit persons to whom the Software is
> furnished to do so, subject to the following conditions:

[wmin]: https://github.com/nicholaswmin
[test-workflow-badge]: https://github.com/nicholaswmin/memstat/actions/workflows/tests.yml/badge.svg
[ci-test]: https://github.com/nicholaswmin/memstat/actions/workflows/tests.yml
[v8-heap-doc]: https://nodejs.org/api/v8.html#v8getheapstatistics
[demo]: .github/docs/demo.png
[tail-demo]: .github/docs/tail-demo.gif
[mocha]: https://mochajs.org/
[no-mocha-arrow]: https://github.com/meteor/guide/issues/318
[examples]: .github/docs/examples
